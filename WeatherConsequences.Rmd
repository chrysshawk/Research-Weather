---
title: "Health and Economic consequences of weather events"
author: "Christoffer Haukvik"
date: "5 Dec 2017"
output: html_document
keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.path='figure/')

## Loading required libraries
library(dplyr)
library(ggplot2)
library(knitr)
library(reshape2)
```

## Health and Economic consequences of weather events

## Synopsis
This analysis uses weather data from x to evaluate the health- and economic consequences of weather in events in US from 1950 - 2011. The main findings are (a) bad weather is bad for health, (b) bad weather is bad for economics.

## Data processing
R has been used to collect and process the data in the following steps.

1. Data is is downloaded, extracted, and loaded in R data frame
```{r dataLoading, cache = TRUE}
if(!file.exists("data.csv.bz2")){
     fileURL <- 
     "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
     download.file(fileURL, dest="data.csv.bz2", 
                   mode="wb", method = "auto") 
}
data <- read.csv("data.csv.bz2")
```

2. Data transformation
In order to improve the processing of the data, we re-format dates
```{r dataProcessing}
# Formatting dates as dates
data$BGN_DATE <- as.Date(data$BGN_DATE, "%m/%d/%Y")
data$END_DATE <- as.Date(data$END_DATE, "%m/%d/%Y")

```


## Results
The analysis has addressed two specific questions:
1. Across the United States, which types of events are most harmful with respect to population health?

Population harm has been measured in two categories; number of fatalities, and number of injuries. Since the former is the more serious of the two, we have chosen to primarily investigate which weather events are most fatal.

To do this, we first summarize the measurements to display a table of the top 10 events which cause the most fatalities. For comparison, we also include the number of injuries which are associated to these events. In order to give an estimate of the percentage risk associated to any given event, we have also included statistics on the mean number of fatalities and injuries are associated with each event.

```{r healthEvents}
# Subsetting events according to fatalities and injuries

healthData <- data %>%
     select(EVTYPE, FATALITIES, INJURIES) %>%
     group_by(EVTYPE) %>%
     summarize(Events = length(EVTYPE),
               Fatalities = sum(FATALITIES),
               Injuries = sum(INJURIES),
               MeanFatalities = round(mean(FATALITIES), 2),
               MeanInjuries = round(mean(INJURIES), 2)) %>%
     arrange(desc(Fatalities))

#1. Table of top 10 fatality and injury causes
kable(head(healthData, 10), row.names = TRUE, 
      col.names = c("Weather event", "Events", "Fatalities", "Injuries", 
                    "Fatalities (mean)", "Injuries (mean)"), 
     caption = "Weather events with greatest health effects")
```
As the table illustrates, tornados are by far the weather event which has the most fatal outcomes. Of the listed events, it also causes the most injuries. Nevertheless, on a per-event basis, it is not as fatal as other of the events listes (in particular heat related events).

```{r fatalEvents}
#2. Figure of top 10 fatality causes and development over time
topFatalities <- arrange(healthData, desc(Fatalities))[1:10, "EVTYPE"]

dFatalities <- data %>%
     filter(EVTYPE %in% topFatalities$EVTYPE) %>%
     group_by(EVTYPE, BGN_DATE) %>%
     summarize(Fatalities = sum(FATALITIES))

ggplot(data = dFatalities, aes(x=BGN_DATE, y=Fatalities)) +
     geom_line(aes(col=EVTYPE)) + 
     theme_light()

```



```{r injuryEvents}
#3. Figure of top 10 injury causes and development over time
topFatality <- head(arrange(healthData, desc(Fatality))$EVTYPE, 10)
fatalityEvents <- subset(healthData, EVTYPE %in% topEvents)
```



```{r misc}
# Subsetting health data
#healthData <- data %>%
#     select(EVTYPE, FATALITIES, INJURIES) %>%
#     group_by(EVTYPE) %>%
#     summarize(Fatality = sum(FATALITIES),
#               Injury = sum(INJURIES))

# Determining and combining the top 5 fatality and injury events
#topFatality <- head(arrange(healthData, desc(Fatality))$EVTYPE, 5)
#topInjury <- head(arrange(healthData, desc(Injury))$EVTYPE, 5)
#topEvents <- unique(combine(topFatality, topInjury))

# Subsetting health data based on top events
#topHealthEvents <- subset(healthData, EVTYPE %in% topEvents)

# Melting data
#healthEvents <- melt(topHealthEvents, id.vars = "EVTYPE", 
#                     measure.vars = c("Fatality", "Injury"), 
#                     value.name = "Incidents", variable.name = "Result")


#ggplot(data = healthEvents, aes(x = EVTYPE, y = Incidents)) +
#     geom_col(fill = "green", alpha = .7) +
#     facet_grid(Result ~ .) +
#     theme_light()

```

2. Across the United States, which types of events have the greatest economic consequences?


## Recommendations


## R Markdown
